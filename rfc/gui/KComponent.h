
/*
	Copyright (C) 2013-2025 CrownSoft
  
	This software is provided 'as-is', without any express or implied
	warranty.  In no event will the authors be held liable for any damages
	arising from the use of this software.

	Permission is granted to anyone to use this software for any purpose,
	including commercial applications, and to alter it and redistribute it
	freely, subject to the following restrictions:

	1. The origin of this software must not be misrepresented; you must not
	   claim that you wrote the original software. If you use this software
	   in a product, an acknowledgment in the product documentation would be
	   appreciated but is not required.
	2. Altered source versions must be plainly marked as such, and must not be
	   misrepresented as being the original software.
	3. This notice may not be removed or altered from any source distribution.	  
*/

#pragma once

#include "../core/CoreModule.h"
#include "KFont.h"
#include "KCursor.h"

/**
	Base class of all W32 gui objects.
*/
class KComponent
{
protected:
	KString compClassName;
	KString compText;
	HWND compHWND;
	HWND compParentHWND;
	DWORD compDwStyle;
	DWORD compDwExStyle;
	UINT compCtlID;
	int compX;
	int compY;
	int compWidth;
	int compHeight;
	int compDPI;
	bool compVisible;
	bool compEnabled;
	bool isRegistered;
	KFont *compFont;
	KCursor *cursor;

public:
	WNDCLASSEXW wc;

	/**
		Constructs a standard win32 component.
		@param generateWindowClassDetails	set to false if you are not registering window class and using standard class name like BUTTON, STATIC etc... wc member is invalid if generateWindowClassDetails is false.
	*/
	KComponent(bool generateWindowClassDetails);
	
	/**
		Returns HWND of this component
	*/
	operator HWND()const;

	/**
		Called after hotplugged into a given HWND.
	*/
	virtual void onHotPlug();

	/**
		HotPlugs given HWND. this method does not update current compFont and cursor variables.
		Set fetchInfo to true if you want to acquire all the information about this HWND. (width, height, position etc...)
		Set fetchInfo to false if you just need to receive events. (button click etc...)
	*/
	virtual void hotPlugInto(HWND component, bool fetchInfo = true);

	/**
		Sets mouse cursor of this component.
	*/
	virtual void setMouseCursor(KCursor* cursor);

	/**
		@returns autogenerated unique class name for this component
	*/
	virtual KString getComponentClassName();

	/**
		Registers the class name and creates the component. 
		Set requireInitialMessages to true to receive initial messages (WM_CREATE etc.)
		@returns false if registration failed or component creation failed.
	*/
	virtual bool create(bool requireInitialMessages = false);

	// called when parent receive WM_DESTROY message.
	virtual void onParentDestroy();

	virtual void destroy();

	/**
		Handles internal window messages. (subclassed window proc)
		Important: Pass unprocessed messages to parent if you override this method.
	*/
	virtual LRESULT windowProc(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam);

	/**
		Receives messages like WM_COMMAND, WM_NOTIFY, WM_DRAWITEM from the parent window. (if it belongs to this component)
		Pass unprocessed messages to parent if you override this method.
		@returns true if msg processed.
	*/
	virtual bool eventProc(UINT msg, WPARAM wParam, LPARAM lParam, LRESULT* result);

	/**
		Identifier of the child component which can be used with WM_MEASUREITEM like messages.
		@returns zero for top level windows
	*/
	virtual UINT getControlID();

	/**
		Sets font of this component. passed font object must live until this component destroy.
	*/
	virtual void setFont(KFont* compFont);

	/**
		Returns font of this component
	*/
	virtual KFont* getFont();

	/**
		Returns caption of this component
	*/
	virtual KString getText();

	/**
		Sets caption of this component
	*/
	virtual void setText(const KString& compText);

	virtual void setHWND(HWND compHWND);

	/**
		Returns HWND of this component
	*/
	virtual HWND getHWND();

	/**
		Changes parent of this component
	*/
	virtual void setParentHWND(HWND compParentHWND);

	/**
		Returns parent of this component
	*/
	virtual HWND getParentHWND();

	/**
		Returns style of this component
	*/
	virtual DWORD getStyle();

	/**
		Sets style of this component
	*/
	virtual void setStyle(DWORD compStyle);

	/**
		Returns exstyle of this component
	*/
	virtual DWORD getExStyle();

	/**
		Sets exstyle of this component
	*/
	virtual void setExStyle(DWORD compExStyle);

	/**
		Returns x position of this component which is relative to parent component.
	*/
	virtual int getX();

	/**
		Returns y position of this component which is relative to parent component.
	*/
	virtual int getY();

	/**
		Returns width of the component.
	*/
	virtual int getWidth();

	/**
		Returns height of the component.
	*/
	virtual int getHeight();

	virtual int getDPI();

	virtual int scaleToCurrentDPI(int valueFor96DPI);

	/**
		Sets width and height of the component.
	*/
	virtual void setSize(int compWidth, int compHeight);

	/**
		Sets x and y position of the component. x and y are relative to parent component
	*/
	virtual void setPosition(int compX, int compY);

	// --- Positioning relative to another component ---
	// The width and height of both this component and the target must be set before calling these methods.
	virtual void placeToRightOf(KComponent& target, int spacing = 10);
	virtual void placeToLeftOf(KComponent& target, int spacing = 10);
	virtual void placeBelow(KComponent& target, int spacing = 10);
	virtual void placeAbove(KComponent& target, int spacing = 10);

	// --- Alignments with another component ---
	// The width and height of both this component and the target must be set before calling these methods.
	virtual void alignTopWith(KComponent& target);
	virtual void alignBottomWith(KComponent& target);
	virtual void alignLeftWith(KComponent& target);
	virtual void alignRightWith(KComponent& target);
	virtual void alignCenterHorizontallyWith(KComponent& target);
	virtual void alignCenterVerticallyWith(KComponent& target);

	virtual void setDPI(int newDPI);

	/**
		Sets visible state of the component
	*/
	virtual void setVisible(bool state);

	/**
		Returns visible state of the component
	*/
	virtual bool isVisible();

	/**
		Returns the component is ready for user input or not
	*/
	virtual bool isEnabled();

	/**
		Sets component's user input reading state
	*/
	virtual void setEnabled(bool state);

	/**
		Brings component to front
	*/
	virtual void bringToFront();

	/**
		Grabs keyboard focus into this component
	*/
	virtual void setKeyboardFocus();

	/**
		Repaints the component
	*/
	virtual void repaint();

	virtual ~KComponent();

private:
	RFC_LEAK_DETECTOR(KComponent)
};


// macros to handle window messages

#define BEGIN_KMSG_HANDLER \
	virtual LRESULT windowProc(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam) override \
	{\
	switch(msg)\
	{

#define ON_KMSG(_KMsg,_KMsgHandler) \
	case _KMsg: return _KMsgHandler(wParam,lParam);

// msvc & clang supports __super keyword

#define END_KMSG_HANDLER \
	default: return __super::windowProc(hwnd,msg,wParam,lParam); \
	}\
	}

